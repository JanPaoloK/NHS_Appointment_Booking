<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tooting GP Practice - Smart Booking System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Landing Page Styles */
        #landingPage {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
        }
        
        .hero {
            text-align: center;
            color: white;
            margin-bottom: 50px;
        }
        
        .hero h1 {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .hero p {
            font-size: 20px;
            opacity: 0.9;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        .card-icon.blue { background: #3b82f6; }
        .card-icon.green { background: #10b981; }
        .card-icon.purple { background: #8b5cf6; }
        
        .card h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .card p {
            color: #666;
            margin-bottom: 15px;
        }
        
        .card-link {
            color: #3b82f6;
            font-weight: 600;
        }
        
        /* Header Styles */
        header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        /* Patient Portal Styles */
        #patientPortal {
            min-height: 100vh;
            background: #f5f5f5;
        }
        
        .main-content {
            padding: 30px 20px;
        }
        
        .welcome-title {
            font-size: 32px;
            margin-bottom: 30px;
            color: #333;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .action-btn {
            background: #3b82f6;
            color: white;
            padding: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            text-align: center;
        }
        
        .action-btn:hover {
            background: #2563eb;
        }
        
        .action-btn.green { background: #10b981; }
        .action-btn.green:hover { background: #059669; }
        .action-btn.purple { background: #8b5cf6; }
        .action-btn.purple:hover { background: #7c3aed; }
        .action-btn.orange { background: #f59e0b; }
        .action-btn.orange:hover { background: #d97706; }
        
        .action-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .appointments-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .appointment-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .appointment-info h4 {
            margin-bottom: 5px;
            color: #333;
        }
        
        .appointment-info p {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .appointment-type {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .type-in-person { background: #dbeafe; color: #1e40af; }
        .type-video { background: #d1fae5; color: #065f46; }
        .type-telephone { background: #fef3c7; color: #92400e; }
        
        .appointment-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-reschedule {
            background: #e5e7eb;
            color: #333;
        }
        
        .btn-reschedule:hover {
            background: #d1d5db;
        }
        
        .btn-cancel {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .btn-cancel:hover {
            background: #fecaca;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: white;
            color: #333;
            padding: 12px 24px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
        }
        
        /* Booking Flow Styles */
        #bookingFlow {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
        }
        
        .progress-step {
            text-align: center;
            position: relative;
            z-index: 1;
            background: white;
            padding: 0 10px;
        }
        
        .progress-step.active .step-circle {
            background: #3b82f6;
            color: white;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
        }
        
        .step-label {
            font-size: 14px;
            color: #666;
        }
        
        .appointment-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .type-option {
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .type-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .type-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
        }
        
        input[type="date"], input[type="time"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        /* Admin Dashboard Styles */
        #adminDashboard {
            min-height: 100vh;
            background: #f5f5f5;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .stat-icon {
            font-size: 24px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }
        
        .stat-change {
            font-size: 14px;
            margin-top: 5px;
        }
        
        .stat-change.positive {
            color: #10b981;
        }
        
        .stat-change.negative {
            color: #ef4444;
        }
        
        .appointments-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px 20px;
            background: #f9fafb;
            font-weight: 600;
            color: #666;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td {
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-approve {
            color: #10b981;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-reject {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .notification.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .notification.info {
            background: #dbeafe;
            color: #1e40af;
        }
.status-pending { background-color: orange; color: white; }
.status-approved { background-color: #28a745; color: white; }
.status-rejected { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
 
        <!-- Login Page -->
<div id="landingPage">
    <div class="container" style="max-width: 400px; margin-top: 80px;">
        
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <h2 style="text-align:center; margin-bottom: 20px;">Login</h2>

            <div class="form-group">
                <label>Username</label>
                <input id="loginUsername" type="text" 
                       style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px;">
            </div>

            <div class="form-group">
                <label>Password</label>
                <input id="loginPassword" type="password" 
                       style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px;">
            </div>

            <button onclick="login()" 
                    class="btn-primary" 
                    style="width:100%; margin-top:10px;">
                Login
            </button>
        </div>

    </div>
</div>
    
    <!-- Patient Portal -->
    <div id="patientPortal" class="hidden">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="header-left">
                        <span style="font-size: 28px;">üè•</span>
                        <span class="header-title">Patient Portal</span>
                    </div>
                    <button class="btn-secondary" onclick="backToLanding()">Sign Out</button>
                </div>
            </div>
        </header>
        
        <div class="main-content container">
            <div id="patientHome">
                <h2 class="welcome-title">Welcome back, John</h2>
                
                <div class="quick-actions">
                    <button class="action-btn" onclick="startAppointmentProcess()">
                        <div class="action-icon">üìÖ</div>
                        <div>Book Appointment</div>
                    </button>
                    <button class="action-btn green" onclick="showSymptomChecker()">
                        <div class="action-icon">ü©∫</div>
                        <div>Symptom Checker</div>
                    </button>
                    <button class="action-btn purple" onclick="openPrescriptions()">
                        <div class="action-icon">üíä</div>
                        <div>Prescriptions</div>
                    </button>
                    <button class="action-btn purple" onclick="openMessagesPage()">
    <div class="action-icon">‚úâÔ∏è</div>
    <div>Messages</div>
</button>
                </div>
                
                <div class="appointments-section">
                    <h3 class="section-title">Your Upcoming Appointments</h3>
                    <div id="appointmentsList">
                        <div class="appointment-item">
                            <div class="appointment-info">
                                <h4>Dr. Sarah Johnson</h4>
                                <p>Monday, 20 Jan 2025 at 09:00</p>
                                <span class="appointment-type type-in-person">In-person</span>
                            </div>
                            <div class="appointment-actions">
                                <button class="btn-small btn-reschedule" onclick="showNotification('Appointment rescheduled', 'info')">Reschedule</button>
                                <button class="btn-small btn-cancel" onclick="cancelAppointment(this)">Cancel</button>
                            </div>
                        </div>
                        
                        <div class="appointment-item">
                            <div class="appointment-info">
                                <h4>Dr. Michael Chen</h4>
                                <p>Wednesday, 22 Jan 2025 at 14:30</p>
                                <span class="appointment-type type-video">Video call</span>
                            </div>
                            <div class="appointment-actions">
                                <button class="btn-small btn-reschedule" onclick="showNotification('Appointment rescheduled', 'info')">Reschedule</button>
                                <button class="btn-small btn-cancel" onclick="cancelAppointment(this)">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

 <!-- Messages Page (Patient) -->
<div id="messagesPage" class="hidden">
  <div style="max-width:800px; margin:0 auto; background:white; padding:30px; border-radius:12px;">
    <h2 class="section-title">üí¨ Secure Messages</h2>
    <p style="margin-bottom:12px;">
      Use this for non-urgent queries (admin, repeat prescriptions, test results). We aim to reply within 48 hours.
      For emergencies call 999 or NHS 111 (option 2).
    </p>

    <div class="form-group">
      <label>Category</label>
      <select id="msgCategory" style="width:100%; padding:12px; border-radius:8px; margin-top:6px;">
        <option value="admin">Admin (appointments, documents)</option>
        <option value="prescription">Prescription (repeat requests)</option>
        <option value="test">Test Result (non-urgent)</option>
        <option value="symptom">Symptom (non-urgent)</option>
      </select>
    </div>

    <div id="triageArea" class="form-group"></div>

    <div class="form-group">
      <label>Message</label>
      <textarea id="msgBody" rows="5" maxlength="2000" placeholder="Briefly describe your request..." style="padding:12px; border-radius:8px;"></textarea>
      <div style="font-size:12px; color:#666; margin-top:6px;">Max 2000 characters</div>
    </div>

    <div style="margin-top:10px;">
      <label><input type="checkbox" id="consentBox"> I consent to this message being stored in my medical record.</label>
    </div>

    <div style="margin-top:16px; display:flex; gap:10px;">
      <button class="btn-primary" onclick="sendMessage()">Send Message</button>
      <button class="btn-secondary" onclick="backToPatientHome()">Cancel</button>
    </div>

    <hr style="margin:20px 0;">
    <h3 class="section-title">Your recent messages</h3>
    <div id="patientMessagesList"></div>
<button class="btn-secondary" style="margin-top: 20px;" onclick="backToPatientHome()">‚Üê Back to Home</button>
  </div>
</div>

            <!-- Booking Flow -->
            <div id="bookingFlow" class="hidden">
                <div class="progress-bar">
                    <div class="progress-step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Type</div>
                    </div>
                    <div class="progress-step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Details</div>
                    </div>
                    <div class="progress-step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Schedule</div>
                    </div>
                    <div class="progress-step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Confirm</div>
                    </div>
                </div>
                
                <div id="bookingStep1">
                    <h3 class="section-title">Select Appointment Type</h3>
                    <div class="appointment-types">
                        <div class="type-option" onclick="selectType(this, 'in-person')">
                            <div style="font-size: 32px;">üè•</div>
                            <h4>In-Person</h4>
                            <p style="font-size: 14px; color: #666;">Visit the practice</p>
                        </div>
                        <div class="type-option" onclick="selectType(this, 'video')">
                            <div style="font-size: 32px;">üìπ</div>
                            <h4>Video Call</h4>
                            <p style="font-size: 14px; color: #666;">Online consultation</p>
                        </div>
                        <div class="type-option" onclick="selectType(this, 'telephone')">
                            <div style="font-size: 32px;">üìû</div>
                            <h4>Telephone</h4>
                            <p style="font-size: 14px; color: #666;">Phone consultation</p>
                        </div>
                        <div class="type-option" onclick="selectType(this, 'econsult')">
                            <div style="font-size: 32px;">üí¨</div>
                            <h4>eConsult</h4>
                            <p style="font-size: 14px; color: #666;">Written consultation</p>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="backToPatientHome()">Cancel</button>
                        <button class="btn-primary" onclick="goToStep2()">Next</button>
                    </div>
                </div>
                
                <div id="bookingStep2" class="hidden">
                    <h3 class="section-title">Describe Your Symptoms</h3>
                    <div class="form-group">
                        <label for="symptoms">Please describe your symptoms or reason for appointment:</label>
                        <textarea id="symptoms" rows="4" placeholder="E.g., I've been experiencing headaches for the past 3 days..."></textarea>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="goToStep1()">Back</button>
                        <button class="btn-primary" onclick="goToStep3()">Next</button>
                    </div>
                </div>
                
                <div id="bookingStep3" class="hidden">
                    <h3 class="section-title">Select Date & Time</h3>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" value="2025-01-20">
                    </div>
                    <div class="form-group">
                        <label for="time">Time</label>
                        <select id="time" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;">
                            <option value="09:00">09:00</option>
                            <option value="09:30">09:30</option>
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="goToStep2()">Back</button>
                        <button class="btn-primary" onclick="goToStep4()">Next</button>
                    </div>
                </div>
                
                <div id="bookingStep4" class="hidden">
                    <h3 class="section-title">Confirm Your Appointment</h3>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin-bottom: 10px;"><strong>Type:</strong> <span id="confirmType">In-Person</span></p>
                        <p style="margin-bottom: 10px;"><strong>Date:</strong> <span id="confirmDate">20 January 2025</span></p>
                        <p style="margin-bottom: 10px;"><strong>Time:</strong> <span id="confirmTime">10:00</span></p>
                        <p style="margin-bottom: 10px;"><strong>Doctor:</strong> Dr. Sarah Johnson</p>
                        <p><strong>Reason:</strong> <span id="confirmReason">General consultation</span></p>
                    </div>
                    <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="color: #1e40af;">üì± You will receive an SMS confirmation and reminder 24 hours before your appointment.</p>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="goToStep3()">Back</button>
                        <button class="btn-primary" style="background: #10b981;" onclick="confirmBooking()">Confirm Booking</button>
                    </div>
                </div>
            </div>
            
            <!-- Symptom Checker -->
            <div id="symptomChecker" class="hidden">
                <div style="max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px;">
                    <h2 class="section-title">ü©∫ Symptom Checker</h2>
                    <p style="margin-bottom: 20px;">This tool helps direct you to the right service based on your symptoms.</p>
                    
                    <div style="space-y: 15px;">
                        <div style="background: #fee2e2; padding: 20px; border-radius: 8px; margin-bottom: 15px; cursor: pointer;" onclick="showNotification('‚ö†Ô∏è Call 999 for emergency symptoms', 'error')">
                            <h3 style="color: #991b1b; margin-bottom: 10px;">üö® Emergency Symptoms</h3>
                            <p style="color: #dc2626;">Chest pain, difficulty breathing, severe bleeding</p>
                        </div>
                        
                        <div style="background: #d1fae5; padding: 20px; border-radius: 8px; margin-bottom: 15px; cursor: pointer;" onclick="showNotification('Visit your local pharmacy for minor ailments', 'info')">
                            <h3 style="color: #065f46; margin-bottom: 10px;">üíä Pharmacy</h3>
                            <p style="color: #059669;">Cold, cough, minor aches, allergies</p>
                        </div>
                        
                        <div style="background: #dbeafe; padding: 20px; border-radius: 8px; margin-bottom: 15px; cursor: pointer;" onclick="goFromSymptomCheckerToBooking()">
    <h3 style="color: #1e40af; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è GP Appointment</h3>
    <p style="color: #2563eb;">Ongoing symptoms, need medical advice</p>
</div>                    
                        <div style="background: #ede9fe; padding: 20px; border-radius: 8px; margin-bottom: 15px; cursor: pointer;" onclick="showMentalHealthPage()">
                            <h3 style="color: #5b21b6; margin-bottom: 10px;">üß† Mental Health</h3>
                            <p style="color: #7c3aed;">Anxiety, depression, stress support</p>
                        </div>
                    </div>
                    
                    <button class="btn-secondary" style="margin-top: 20px;" onclick="backToPatientHome()">‚Üê Back to Home</button>
                </div>
            </div>
        </div>

<!-- Mental Health Page -->
<div id="mentalHealthPage" class="hidden">
    <div style="max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px;">
        <h2 class="section-title">üß† Mental Health Support</h2>
        <p style="margin-bottom: 20px;">Select the option that best describes your situation:</p>

        <!-- TRIAGE OPTIONS -->
        <div style="space-y: 15px;">

            <!-- CRISIS -->
            <div style="background: #fee2e2; padding: 20px; border-radius: 8px; margin-bottom: 15px; cursor: pointer;"
                 onclick="showMentalHealthOutcome('crisis')">
                <h3 style="color: #991b1b; margin-bottom: 10px;">üö® I'm in crisis or feel unsafe</h3>
                <p style="color: #dc2626;">Thoughts of self-harm, feeling at risk, or immediate danger</p>
            </div>

            <!-- URGENT BUT NOT CRISIS -->
            <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 15px; cursor: pointer;"
                 onclick="showMentalHealthOutcome('urgent')">
                <h3 style="color: #b45309; margin-bottom: 10px;">‚ö†Ô∏è I need urgent support</h3>
                <p style="color: #92400e;">Severe anxiety, panic, or worsening symptoms</p>
            </div>

            <!-- ROUTINE HELP -->
            <div style="background: #dbeafe; padding: 20px; border-radius: 8px; margin-bottom: 15px; cursor: pointer;"
                 onclick="showMentalHealthOutcome('routine')">
                <h3 style="color: #1e40af; margin-bottom: 10px;">üí¨ I want general mental health help</h3>
                <p style="color: #2563eb;">Anxiety, low mood, stress, sleep problems</p>
            </div>

        </div>

        <button class="btn-secondary" style="margin-top: 20px;" onclick="backToPatientHome()">‚Üê Back to Home</button>
    </div>
</div>

<!-- Prescriptions Page -->
<div id="prescriptionsPage" class="hidden">
    <div style="max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px;">
        <h2 class="section-title">üíä Your Prescriptions</h2>

        <!-- Repeat Prescriptions -->
        <h3 style="margin-top: 20px; margin-bottom: 10px;">Current Repeat Prescriptions</h3>
        <div id="repeatPrescriptionsList" style="margin-bottom: 25px;"></div>

        <!-- One-off Prescriptions -->
        <h3 style="margin-bottom: 10px;">Recent One-off Prescriptions</h3>
        <div id="acutePrescriptionsList" style="margin-bottom: 25px;"></div>

        <!-- Request New Medication -->
        <h3 style="margin-bottom: 10px;">Request New Medication</h3>
        <div style="background:#f9fafb; padding: 15px; border-radius:8px; margin-bottom: 20px;">
            <label><strong>Medication name</strong></label>
            <input id="requestMedName" type="text" placeholder="e.g. Omeprazole 20mg"
                   style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; margin-top:5px;">

            <label style="margin-top:15px; display:block;"><strong>Notes (optional)</strong></label>
            <textarea id="requestMedNotes" rows="3" placeholder="Reason or additional information"
                      style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px;"></textarea>

            <button class="btn-primary" style="margin-top: 15px;" onclick="submitPrescriptionRequest()">
                Submit Request
            </button>
        </div>

        <!-- Request Status -->
        <h3 style="margin-bottom: 10px;">Your Requests</h3>
        <div id="prescriptionRequestsList"></div>

        <button class="btn-secondary" style="margin-top: 20px;" onclick="backToPatientHome()">‚Üê Back to Home</button>
    </div>
</div>
    </div>
    
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="header-left">
                        <span style="font-size: 28px;">‚öôÔ∏è</span>
                        <span class="header-title">Admin Dashboard</span>
                    </div>
                    <div style="text-align: right; display:flex; gap:10px; justify-content:flex-end; align-items:center;">
    <button class="btn-secondary" onclick="openAdminMessages()">üì® Inbox</button>
    <button class="btn-secondary" onclick="logout()">Sign Out</button>
</div>
                </div>
            </div>
        </header>
        
        <div class="main-content container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Today's Appointments</span>
                        <span class="stat-icon">üìÖ</span>
                    </div>
                    <div class="stat-value">24</div>
                    <div class="stat-change positive">+12% from yesterday</div>
                </div>
<button class="action-btn purple" onclick="showStaffInbox()">
  <div class="action-icon">‚úâÔ∏è</div>
  <div>Messages Inbox</div>
</button>       
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">DNA Rate</span>
                        <span class="stat-icon">üìâ</span>
                    </div>
                    <div class="stat-value">6%</div>
                    <div class="stat-change positive">-2% from last month</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Pending Reviews</span>
                        <span class="stat-icon">‚è∞</span>
                    </div>
                    <div class="stat-value">3</div>
                    <div class="stat-change">Requires attention</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Call Reduction</span>
                        <span class="stat-icon">üìû</span>
                    </div>
                    <div class="stat-value">34%</div>
                    <div class="stat-change positive">Since app launch</div>
                </div>
            </div>

<!-- ADMIN MESSAGES PAGE -->
<div id="adminMessagesPage" class="hidden">
  <div style="max-width:900px; margin:0 auto; background:white; padding:30px; border-radius:12px;">
    <h2 class="section-title">üì® All Open Messages</h2>
    <p style="margin-bottom:20px;">These are all active chats from patients. Click any to open and reply.</p>

    <div id="adminMessagesList"></div>

    <button class="btn-secondary" style="margin-top:20px;" onclick="backToAdminHome()">‚Üê Back to Dashboard</button>
  </div>
</div>

            <!-- Staff Inbox (Admin Dashboard) -->
<div id="staffInbox" class="hidden" style="margin-top:20px;">
  <div style="background:white; padding:20px; border-radius:8px;">
    <h3 class="section-title">Inbox ‚Äî Messages</h3>

    <div style="display:flex; gap:10px; margin-bottom:12px;">
      <select id="staffQueueFilter" onchange="loadStaffInbox()" style="padding:8px;">
        <option value="all">All queues</option>
        <option value="admin">Admin</option>
        <option value="prescription">Prescription</option>
        <option value="test">Test Result</option>
        <option value="symptom">Symptom</option>
      </select>
      <button class="btn-secondary" onclick="showStaffInbox()">Open Inbox</button>
    </div>

    <div id="staffMessagesList" style="max-height:320px; overflow:auto;"></div>

    <div id="staffMessageDetail" style="display:none; margin-top:12px; border-top:1px solid #eee; padding-top:12px;">
      <div id="staffDetailContent"></div>
      <div style="margin-top:10px;">
        <select id="replyTemplate">
          <option value="">‚Äî choose template ‚Äî</option>
          <option value="prescApproved">Prescription approved: "Your repeat has been authorised and will be sent to {pharmacy}."</option>
          <option value="needMoreInfo">Request more info: "Could you tell us how long you've had symptoms and any medications you're taking?"</option>
          <option value="adminReply">Admin: "We've updated your appointment to {date} {time}."</option>
        </select>
      </div>
      <textarea id="staffReplyBody" rows="4" style="width:100%; margin-top:8px; padding:10px;"></textarea>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button class="btn-primary" onclick="staffReply()">Send Reply</button>
        <button class="btn-secondary" onclick="closeStaffDetail()">Close</button>
        <button class="btn-secondary" onclick="assignToMe()">Assign to me</button>
        <button class="btn-secondary" onclick="closeMessageStaff()">Mark Closed</button>
      </div>
    </div>
  </div>
</div>
            <div class="appointments-table">
                <div class="table-header">
                    <h3 class="section-title" style="margin: 0;">Today's Appointments</h3>
                    <div>
                        <button class="btn-secondary" style="padding: 8px 16px; font-size: 14px;">Filter</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Patient</th>
                            <th>Type</th>
                            <th>Doctor</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsTableBody">
                        <tr>
                            <td>09:00</td>
                            <td>John Smith</td>
                            <td><span class="appointment-type type-in-person">In-person</span></td>
                            <td>Dr. Sarah Johnson</td>
                            <td><span class="status-badge status-confirmed">Confirmed</span></td>
                            <td><button class="btn-approve">View</button></td>
                        </tr>
                        <tr>
                            <td>09:30</td>
                            <td>Emma Wilson</td>
                            <td><span class="appointment-type type-video">Video</span></td>
                            <td>Dr. Michael Chen</td>
                            <td><span class="status-badge status-confirmed">Confirmed</span></td>
                            <td><button class="btn-approve">View</button></td>
                        </tr>
                        <tr>
                            <td>10:00</td>
                            <td>Rajesh Patel</td>
                            <td><span class="appointment-type type-telephone">Telephone</span></td>
                            <td>Dr. Sarah Johnson</td>
                            <td><span class="status-badge status-pending">Pending</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-approve" onclick="approveAppointment(this)">Approve</button>
                                    <button class="btn-reject" onclick="rejectAppointment(this)">Reject</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>10:30</td>
                            <td>Maria Garcia</td>
                            <td><span class="appointment-type type-in-person">In-person</span></td>
                            <td>Nurse Adams</td>
                            <td><span class="status-badge status-confirmed">Confirmed</span></td>
                            <td><button class="btn-approve">View</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let selectedType = '';
        let currentStep = 1;

        // Demo users
const users = [
    { username: "john", password: "1234", role: "patient" },
    { username: "admin", password: "admin123", role: "admin" }
];

// Shared appointment storage
let appointments = JSON.parse(localStorage.getItem("appointments")) || [];

function saveAppointments() {
    localStorage.setItem("appointments", JSON.stringify(appointments));
}

        function showPatientPortal() {
loadPatientAppointments();
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('patientPortal').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

function loadPatientAppointments() {
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));

    const userAppointments = appointments.filter(a => a.patient === currentUser.username);

    const container = document.getElementById("patientAppointmentsList");
    if (!container) return; // in case portal not rendered yet

    container.innerHTML = "";

    if (userAppointments.length === 0) {
        container.innerHTML = "<p>You have no appointments yet.</p>";
        return;
    }

    userAppointments.forEach(app => {
        const card = document.createElement("div");
        card.className = "appointment-card";
        card.innerHTML = `
            <h3>${app.type} Appointment</h3>
            <p><strong>Doctor:</strong> ${app.doctor}</p>
            <p><strong>Date:</strong> ${app.date}</p>
            <p><strong>Time:</strong> ${app.time}</p>
            <p><strong>Status:</strong> ${app.status}</p>
        `;
        container.appendChild(card);
    });
}

/* ---------- Messaging Phase 1 (localStorage-based MVP) ---------- */
const MESSAGES_KEY = 'app_messages_v1';
const EVENTS_KEY = 'app_message_events_v1';

// helper
function nowISO() { return new Date().toISOString(); }
function genId() { return 'm-' + Date.now() + '-' + Math.floor(Math.random()*9999); }

// Basic rate limiter: max 3 messages in last 7 days
function tooManyRecentMessages(patient) {
  const msgs = JSON.parse(localStorage.getItem(MESSAGES_KEY) || '[]');
  const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000;
  const recent = msgs.filter(m => m.patient === patient && new Date(m.created_at).getTime() > cutoff);
  return recent.length >= 3;
}

function saveMessages(arr) { localStorage.setItem(MESSAGES_KEY, JSON.stringify(arr || [])); }
function loadMessages() { return JSON.parse(localStorage.getItem(MESSAGES_KEY) || '[]'); }
function saveEvents(arr) { localStorage.setItem(EVENTS_KEY, JSON.stringify(arr || [])); }
function loadEvents(){ return JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]'); }

function appendEvent(messageId, actorType, actorId, event, details={}) {
  const evts = loadEvents();
  evts.push({ id:'e-'+Date.now(), messageId, actorType, actorId, event, details, ts: nowISO() });
  saveEvents(evts);
}

/* --- UI openers --- */
function openMessagesPage() {
  // hide other patient pages
  document.getElementById('patientHome').classList.add('hidden');
  document.getElementById('bookingFlow').classList.add('hidden');
  document.getElementById('symptomChecker').classList.add('hidden');
  document.getElementById('prescriptionsPage')?.classList.add('hidden');
  document.getElementById('mentalHealthPage')?.classList.add('hidden');

  document.getElementById('messagesPage').classList.remove('hidden');
  renderTriageForCategory(); // default
  loadPatientMessages();
}

/* create triage UI based on category */
document.getElementById('msgCategory')?.addEventListener('change', renderTriageForCategory);
function renderTriageForCategory() {
  const cat = document.getElementById('msgCategory').value;
  const area = document.getElementById('triageArea');
  if (!area) return;
  area.innerHTML = '';

  // Common red-flag detector UI for 'symptom' and 'test'
  if (cat === 'symptom') {
    area.innerHTML = `
      <label><strong>Do you have any of the following?</strong></label>
      <div><label><input type="checkbox" id="tf_suicidal"> Thoughts of self-harm or suicide</label></div>
      <div><label><input type="checkbox" id="tf_chest"> Chest pain or severe breathlessness</label></div>
      <div><label><input type="checkbox" id="tf_bleed"> Heavy bleeding / sudden weakness</label></div>
    `;
  } else if (cat === 'prescription') {
    area.innerHTML = `
      <label><strong>Prescription triage</strong></label>
      <div><label><input type="checkbox" id="tf_allergic"> New rash or suspected allergy to medication</label></div>
      <div><label><input type="checkbox" id="tf_urgent"> Is this an urgent/acute need (eg. running out within 24 hours)?</label></div>
    `;
  } else if (cat === 'test') {
    area.innerHTML = `
      <label><strong>Test result triage</strong></label>
      <div><label><input type="checkbox" id="tf_abnormal"> Severe or worrying result explained to you previously</label></div>
      <div><label><input type="checkbox" id="tf_symptomRelate"> Related symptoms worsening</label></div>
    `;
  } else {
    area.innerHTML = `<small>Use this for admin requests (appointments, letters).</small>`;
  }
}

/* client-side deterministic red-flag check */
function hasRedFlag(cat) {
  if (cat === 'symptom') {
    if (document.getElementById('tf_suicidal')?.checked) return {flag:true, message:'If you feel at risk of harming yourself, call 999 now or go to A&E.'};
    if (document.getElementById('tf_chest')?.checked) return {flag:true, message:'Chest pain / severe breathlessness ‚Äî call 999 immediately.'};
    if (document.getElementById('tf_bleed')?.checked) return {flag:true, message:'Severe bleeding / sudden weakness ‚Äî call 999 immediately.'};
  }
  if (cat === 'prescription') {
    if (document.getElementById('tf_allergic')?.checked) return {flag:true, message:'You may be having an allergic reaction ‚Äî call 999 if severe.'};
  }
  if (cat === 'test') {
    if (document.getElementById('tf_symptomRelate')?.checked) return {flag:true, message:'If symptoms are worsening please call 111 or 999 depending on severity.'};
  }
  return {flag:false};
}

/* send message (patient) */
function sendMessage() {
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
  if (!currentUser || !currentUser.username) { showNotification('Please login as a patient to send a message','error'); return; }

  const cat = document.getElementById('msgCategory').value;
  const body = document.getElementById('msgBody').value.trim();
  const consent = document.getElementById('consentBox').checked;

  // validation
  if (!consent) { showNotification('Please give consent to record this message', 'error'); return; }
  if (!body) { showNotification('Please enter a message', 'error'); return; }

  // red flag check
  const rf = hasRedFlag(cat);
  if (rf.flag) { showNotification(rf.message, 'error'); return; }

  // rate limit
  if (tooManyRecentMessages(currentUser.username)) {
    showNotification('You have reached the message limit (3 messages in 7 days). Please wait or contact the practice by phone.', 'error');
    return;
  }

  // Create message object
  const messages = loadMessages();
  const id = genId();
  const created = nowISO();
  const triageAnswers = {}; // capture checked triage answers
  document.querySelectorAll('#triageArea input[type=checkbox]').forEach(cb => triageAnswers[cb.id] = cb.checked);

  const message = {
    id,
    patient: currentUser.username,
    category: cat,
    subject: body.split('\n')[0].slice(0,80),
    body,
    triage_answers: triageAnswers,
    consent_given: true,
    status: 'new',
    priority: 'normal',
    created_at: created,
    updated_at: created,
    assigned_to: null,
    sla_deadline: new Date(Date.now() + 48*3600*1000).toISOString()
  };

  messages.push(message);
  saveMessages(messages);

  appendEvent(id, 'patient', currentUser.username, 'created', {category:cat});
  showNotification('Message sent. We aim to reply within 48 hours.', 'success');

  // reset form + reload
  document.getElementById('msgBody').value = '';
  document.getElementById('consentBox').checked = false;
  renderTriageForCategory();
  loadPatientMessages();

  // Notify staff (in real app, call server to notify staff)
}

/* load recent patient messages */
function loadPatientMessages() {
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
  const container = document.getElementById('patientMessagesList');
  if (!container) return;
  container.innerHTML = '';

  const msgs = loadMessages().filter(m => m.patient === currentUser.username).sort((a,b) => new Date(b.created_at)-new Date(a.created_at));
  if (msgs.length === 0) { container.innerHTML = '<p>No messages yet.</p>'; return; }

  msgs.forEach(m => {
    const div = document.createElement('div');
    div.className = 'appointment-item';
    div.innerHTML = `
      <div style="flex:1;">
        <strong>${m.subject}</strong>
        <div style="font-size:12px;color:#666;">${m.category} ‚Ä¢ ${new Date(m.created_at).toLocaleString()}</div>
        <div style="margin-top:6px;">${m.body}</div>
        <div style="font-size:12px; margin-top:6px;">Status: <span class="status-badge status-${m.status}">${m.status}</span></div>
      </div>
      <div style="margin-left:10px; text-align:right;">
        <button class="btn-small" onclick="viewPatientMessage('${m.id}')">View</button>
      </div>
    `;
    container.appendChild(div);
  });
}

/* view single patient message detail (simple) */
function viewPatientMessage(id) {
  const msgs = loadMessages();
  const m = msgs.find(x => x.id === id);
  if (!m) return;
  const detail = `
    <h4>${m.subject}</h4>
    <p><strong>Category:</strong> ${m.category}</p>
    <p><strong>Sent:</strong> ${new Date(m.created_at).toLocaleString()}</p>
    <p>${m.body}</p>
    <hr>
    <h5>Events</h5>
    ${loadEvents().filter(e => e.messageId === id).map(e => `<div style="font-size:12px;color:#666;">${e.ts} ‚Äî ${e.actorType}:${e.actorId} ‚Äî ${e.event}</div>`).join('')}
  `;
  // show in modal-like notification for simplicity
  showNotification(detail, 'info');
}

/* ---------- Staff inbox functions (Admin) ---------- */
function showStaffInbox() {
  document.getElementById('staffInbox').classList.remove('hidden');
  document.getElementById('staffInbox').scrollIntoView({behavior:'smooth'});
  loadStaffInbox();
}

function loadStaffInbox() {
  const queue = document.getElementById('staffQueueFilter')?.value || 'all';
  const list = document.getElementById('staffMessagesList');
  if (!list) return;
  list.innerHTML = '';

  let msgs = loadMessages().slice().sort((a,b) => new Date(b.created_at)-new Date(a.created_at));
  if (queue !== 'all') msgs = msgs.filter(m => m.category === queue);

  if (msgs.length === 0) { list.innerHTML = '<p>No messages in this queue.</p>'; return; }

  msgs.forEach(m => {
    const el = document.createElement('div');
    el.className = 'appointment-item';
    el.innerHTML = `
      <div style="flex:1;">
        <strong>${m.subject}</strong>
        <div style="font-size:12px;color:#666;">${m.patient} ‚Ä¢ ${m.category} ‚Ä¢ ${new Date(m.created_at).toLocaleString()}</div>
        <div style="font-size:12px; margin-top:6px;">Status: <span class="status-badge status-${m.status}">${m.status}</span></div>
      </div>
      <div style="display:flex; flex-direction:column; gap:6px; margin-left:10px;">
        <button class="btn-small" onclick="openStaffMessageDetail('${m.id}')">Open</button>
      </div>
    `;
    list.appendChild(el);
  });
}

function openStaffMessageDetail(id) {
  const m = loadMessages().find(x => x.id === id);
  if (!m) return;
  document.getElementById('staffMessageDetail').style.display = 'block';
  const content = document.getElementById('staffDetailContent');
  content.innerHTML = `
    <h4>${m.subject}</h4>
    <p><strong>Patient:</strong> ${m.patient} ‚Ä¢ <strong>Category:</strong> ${m.category}</p>
    <p><strong>Sent:</strong> ${new Date(m.created_at).toLocaleString()}</p>
    <p>${m.body}</p>
    <hr>
    <div><strong>Triage answers:</strong><pre style="font-size:12px;">${JSON.stringify(m.triage_answers,null,2)}</pre></div>
    <hr>
    <div><strong>Events</strong><div id="evtList" style="font-size:12px; color:#666;">${loadEvents().filter(e=>e.messageId===id).map(e=>`${e.ts} ‚Äî ${e.actorType}:${e.actorId} ‚Äî ${e.event}`).join('<br>')}</div></div>
  `;
  // mark as open if new
  if (m.status === 'new') {
    updateMessageStatus(id, 'open');
  }
  // store selected id for reply
  document._selectedMessageId = id;
  document.getElementById('staffReplyBody').value = '';
}

function closeStaffDetail() {
  document.getElementById('staffMessageDetail').style.display = 'none';
  document._selectedMessageId = null;
}

function updateMessageStatus(id, status) {
  const msgs = loadMessages();
  const idx = msgs.findIndex(x => x.id === id);
  if (idx === -1) return;
  msgs[idx].status = status;
  msgs[idx].updated_at = nowISO();
  saveMessages(msgs);
  appendEvent(id, 'system', 'system', `status:${status}`, {});
  loadStaffInbox();
  loadPatientMessages();
}

function assignToMe() {
  const id = document._selectedMessageId;
  const current = JSON.parse(localStorage.getItem('currentUser')||'{}');
  const msgs = loadMessages();
  const idx = msgs.findIndex(x=>x.id===id);
  if (idx === -1) return;
  msgs[idx].assigned_to = current.username || 'admin';
  msgs[idx].updated_at = nowISO();
  saveMessages(msgs);
  appendEvent(id, 'staff', current.username || 'admin', 'assigned', {});
  openStaffMessageDetail(id);
}

/* Staff sends a reply; in a real app this would create a message record and notify patient */
function staffReply() {
  const id = document._selectedMessageId;
  if (!id) return showNotification('No message selected','error');
  const body = document.getElementById('staffReplyBody').value.trim();
  if (!body) return showNotification('Enter reply text','error');

  const msgs = loadMessages();
  const idx = msgs.findIndex(x=>x.id===id);
  if (idx === -1) return;
  // create an event storing staff reply; also change status to 'waiting' (waiting patient)
  const current = JSON.parse(localStorage.getItem('currentUser')||'{}');
  appendEvent(id, 'staff', current.username || 'admin', 'reply', { body });
  // Optionally store the reply inside message as replies array
  msgs[idx].replies = msgs[idx].replies || [];
  msgs[idx].replies.push({ by: current.username || 'admin', body, ts: nowISO() });
  msgs[idx].status = 'waiting';
  msgs[idx].updated_at = nowISO();
  saveMessages(msgs);

  // Optionally: send notification to patient (in real app -> push/email/SMS)
  appendEvent(id, 'system', 'system', 'patient_notified', { method:'in-app' });

  showNotification('Reply sent and patient notified (demo).', 'success');
  loadStaffInbox();
  closeStaffDetail();
  loadPatientMessages();
}

function closeMessageStaff() {
  const id = document._selectedMessageId;
  if (!id) return;
  updateMessageStatus(id, 'closed');
  appendEvent(id, 'staff', JSON.parse(localStorage.getItem('currentUser')||'{}').username || 'admin', 'closed', {});
  showNotification('Message marked closed', 'info');
}

/* quick template insertion */
document.getElementById('replyTemplate')?.addEventListener('change', function() {
  const v = this.value;
  const box = document.getElementById('staffReplyBody');
  if (!box) return;
  if (v === 'prescApproved') box.value = 'Your repeat prescription has been authorised and will be sent to your nominated pharmacy.';
  if (v === 'needMoreInfo') box.value = 'Thanks ‚Äî could you please tell us how long you have had the symptoms and any medication you are taking?';
  if (v === 'adminReply') box.value = 'Your appointment has been updated. Please check details in your portal.';
});

function openAdminMessages() {
  // hide other admin UI
  document.getElementById('adminDashboard').classList.add('hidden');
  
  // show messages page
  document.getElementById('adminMessagesPage').classList.remove('hidden');

  loadAdminMessages();
}

function loadAdminMessages() {
  const list = document.getElementById('adminMessagesList');
  list.innerHTML = '';

  const msgs = loadMessages().filter(m => m.status !== 'closed'); // only open chats
  
  if (msgs.length === 0) {
    list.innerHTML = "<p>No open chats.</p>";
    return;
  }

  msgs.forEach(msg => {
    const div = document.createElement('div');
    div.className = "appointment-item";
    div.style.cursor = "pointer";

    div.innerHTML = `
      <div>
        <strong>${msg.subject}</strong>
        <div style="font-size:12px; color:#666;">
          ${msg.patient} ‚Ä¢ ${msg.category} ‚Ä¢ ${new Date(msg.created_at).toLocaleString()}
        </div>
      </div>
      <button class="btn-small">Open Chat</button>
    `;

    // clicking opens the detailed inbox view (staff inbox)
    div.onclick = () => {
      // show full staff inbox (message detail view)
      showStaffInbox();
      openStaffMessageDetail(msg.id);
    };

    list.appendChild(div);
  });
}

function backToAdminHome() {
  document.getElementById('adminMessagesPage').classList.add('hidden');
  document.getElementById('adminDashboard').classList.remove('hidden');
}
        
        function showAdminDashboard() {
loadAdminAppointments();
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('patientPortal').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
        }

function showStaffInbox() {
  document.getElementById('adminDashboard').classList.add('hidden');
  document.getElementById('staffInbox').classList.remove('hidden');
  loadStaffInbox();
}

function backToAdminHome() {
  document.getElementById('staffInbox').classList.add('hidden');
  document.getElementById('staffMessageDetail').style.display = 'none';
  document.getElementById('adminDashboard').classList.remove('hidden');
}

function loadAdminAppointments() {
    const table = document.getElementById("appointmentsTableBody");
    table.innerHTML = "";

    appointments.forEach((app, index) => { 
        const row = document.createElement("tr");
        row.innerHTML = `
    <td>${app.time}</td>
    <td>${app.patient}</td>
    <td><span class="appointment-type">${app.type}</span></td>
    <td>${app.doctor}</td>
    <td><span class="status-badge status-${app.status}">${app.status}</span></td>
    <td>
        ${app.status === "pending" ? `
            <button class="btn-approve" onclick="approveAppointment(${index})">Approve</button>
            <button class="btn-reject" onclick="rejectAppointment(${index})">Reject</button>
        ` : ""}
    </td>
`;
        table.appendChild(row);
    });
}

document.getElementById('date').value = new Date().toISOString().split('T')[0];
document.getElementById('date').addEventListener("change", function () {
    loadAvailableTimes();
});
function approveAppointment(index) {
    appointments[index].status = "approved";
    saveAppointments();
    loadAdminAppointments();
    loadPatientAppointments();
}

function rejectAppointment(index) {
    appointments[index].status = "rejected";
    saveAppointments();
    loadAdminAppointments();
    loadPatientAppointments();
}

const allTimeSlots = [
    "09:00", "09:30", "10:00", "10:30",
    "11:00", "11:30", "12:00",
    "14:00", "14:30", "15:00", "15:30",
    "16:00"
];

function getAvailableSlots(date) {

    // Find all appointments for that date
    const booked = appointments
        .filter(a => a.date === date && a.status !== "rejected")
        .map(a => a.time);

    // Remove booked times from available list
    return allTimeSlots.filter(t => !booked.includes(t));
}

function loadAvailableTimes() {
    const date = document.getElementById('date').value;
    const select = document.getElementById('time');

    const available = getAvailableSlots(date);

    select.innerHTML = "";
    available.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        select.appendChild(opt);
    });
}

loadAvailableTimes();
        
        function backToLanding() {
            document.getElementById('landingPage').classList.remove('hidden');
            document.getElementById('patientPortal').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

function startAppointmentProcess() {
    document.getElementById('patientHome').classList.add('hidden');
    document.getElementById('bookingFlow').classList.add('hidden');
    document.getElementById('symptomChecker').classList.remove('hidden');
}        

let prescriptions = JSON.parse(localStorage.getItem("prescriptions")) || {
    repeat: [
        { name: "Atorvastatin 20mg", instructions: "Take one daily", status: "active", lastIssued: "2025-01-10" },
        { name: "Salbutamol Inhaler", instructions: "2 puffs when needed", status: "active", lastIssued: "2024-12-28" }
    ],
    acute: [
        { name: "Amoxicillin 500mg", issued: "2025-01-05", status: "completed" }
    ],
    requests: []
};

function savePrescriptions() {
    localStorage.setItem("prescriptions", JSON.stringify(prescriptions));
}

function openPrescriptions() {
    document.getElementById('patientHome').classList.add('hidden');
    document.getElementById('symptomChecker').classList.add('hidden');
    document.getElementById('bookingFlow').classList.add('hidden');
    document.getElementById('prescriptionsPage').classList.remove('hidden');

    loadPrescriptions();
}

function loadPrescriptions() {

    // Repeat prescriptions
    const repeatContainer = document.getElementById("repeatPrescriptionsList");
    repeatContainer.innerHTML = "";
    prescriptions.repeat.forEach(med => {
        const div = document.createElement("div");
        div.className = "appointment-item";
        div.innerHTML = `
            <div>
                <h4>${med.name}</h4>
                <p>${med.instructions}</p>
                <p><strong>Last issued:</strong> ${med.lastIssued}</p>
            </div>
            <button class="btn-small btn-reschedule" onclick="requestRepeat('${med.name}')">Request Again</button>
        `;
        repeatContainer.appendChild(div);
    });

    // Acute prescriptions
    const acuteContainer = document.getElementById("acutePrescriptionsList");
    acuteContainer.innerHTML = "";
    prescriptions.acute.forEach(med => {
        const div = document.createElement("div");
        div.className = "appointment-item";
        div.innerHTML = `
            <div>
                <h4>${med.name}</h4>
                <p><strong>Issued:</strong> ${med.issued}</p>
            </div>
        `;
        acuteContainer.appendChild(div);
    });

    // Requests
    const reqContainer = document.getElementById("prescriptionRequestsList");
    reqContainer.innerHTML = "";
    prescriptions.requests.forEach(req => {
        const div = document.createElement("div");
        div.className = "appointment-item";
        div.innerHTML = `
            <div>
                <h4>${req.name}</h4>
                <p>${req.notes || "No notes provided"}</p>
            </div>
            <span class="status-badge status-${req.status}">${req.status}</span>
        `;
        reqContainer.appendChild(div);
    });
}

function requestRepeat(name) {
    prescriptions.requests.push({
        name,
        notes: "(repeat request)",
        status: "pending"
    });
    savePrescriptions();
    loadPrescriptions();
    showNotification("Repeat prescription request sent!", "success");
}

function submitPrescriptionRequest() {
    const name = document.getElementById("requestMedName").value.trim();
    if (!name) {
        showNotification("Medication name is required", "error");
        return;
    }

    const notes = document.getElementById("requestMedNotes").value.trim();

    prescriptions.requests.push({
        name,
        notes,
        status: "pending"
    });

    savePrescriptions();
    loadPrescriptions();
    showNotification("Your medication request has been submitted!", "success");

    document.getElementById("requestMedName").value = "";
    document.getElementById("requestMedNotes").value = "";
}

        function showBookingFlow() {
            document.getElementById('patientHome').classList.add('hidden');
            document.getElementById('bookingFlow').classList.remove('hidden');
            document.getElementById('symptomChecker').classList.add('hidden');
            goToStep1();
        }
        
        function showSymptomChecker() {
            document.getElementById('patientHome').classList.add('hidden');
            document.getElementById('bookingFlow').classList.add('hidden');
            document.getElementById('symptomChecker').classList.remove('hidden');
        }

function showMentalHealthPage() {
    document.getElementById('patientHome').classList.add('hidden');
    document.getElementById('symptomChecker').classList.add('hidden');
    document.getElementById('bookingFlow').classList.add('hidden');
    document.getElementById('prescriptionsPage').classList.add('hidden');
    document.getElementById('mentalHealthPage').classList.remove('hidden');
}

function showMentalHealthOutcome(level) {
    let msg = "";

    if (level === "crisis") {
        msg = `üö® Immediate Help Required

If you feel unsafe or at risk of harming yourself, call 999 or go to A&E immediately.`;
    }

    if (level === "urgent") {
        msg = `‚ö†Ô∏è Urgent Mental Health Support

Call NHS 111 and choose option 2 for 24/7 urgent mental health advice.`;
    }

    if (level === "routine") {
        msg = `üí¨ Talking Therapies

You can self-refer to NHS Talking Therapies for help with anxiety, stress or low mood.

If you'd prefer, you can also book a GP appointment.`;
    }

    showNotification(msg, "info");
}

function goFromSymptomCheckerToBooking() {
    document.getElementById('symptomChecker').classList.add('hidden');
    showBookingFlow();
}
        
        function backToPatientHome() {
    document.getElementById('patientHome').classList.remove('hidden');
    document.getElementById('bookingFlow').classList.add('hidden');
    document.getElementById('symptomChecker').classList.add('hidden');
    document.getElementById('prescriptionsPage').classList.add('hidden'); // ‚≠ê FIX
    document.getElementById('mentalHealthPage').classList.add('hidden');
    document.getElementById('messagesPage').classList.add('hidden');
}
        
        function selectType(element, type) {
            document.querySelectorAll('.type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedType = type;
        }
        
        function goToStep1() {
            currentStep = 1;
            updateProgressBar();
            document.getElementById('bookingStep1').classList.remove('hidden');
            document.getElementById('bookingStep2').classList.add('hidden');
            document.getElementById('bookingStep3').classList.add('hidden');
            document.getElementById('bookingStep4').classList.add('hidden');
        }
        
        function goToStep2() {
            if (!selectedType) {
                showNotification('Please select an appointment type', 'error');
                return;
            }
            currentStep = 2;
            updateProgressBar();
            document.getElementById('bookingStep1').classList.add('hidden');
            document.getElementById('bookingStep2').classList.remove('hidden');
            document.getElementById('bookingStep3').classList.add('hidden');
            document.getElementById('bookingStep4').classList.add('hidden');
        }
        
        function goToStep3() {
            currentStep = 3;
            updateProgressBar();
            document.getElementById('bookingStep1').classList.add('hidden');
            document.getElementById('bookingStep2').classList.add('hidden');
            document.getElementById('bookingStep3').classList.remove('hidden');
            document.getElementById('bookingStep4').classList.add('hidden');
        }
        
        function goToStep4() {
            currentStep = 4;
            updateProgressBar();
            
            // Update confirmation details
            document.getElementById('confirmType').textContent = selectedType || 'In-Person';
            document.getElementById('confirmDate').textContent = document.getElementById('date').value || '20 January 2025';
            document.getElementById('confirmTime').textContent = document.getElementById('time').value || '10:00';
            document.getElementById('confirmReason').textContent = document.getElementById('symptoms').value || 'General consultation';
            
            document.getElementById('bookingStep1').classList.add('hidden');
            document.getElementById('bookingStep2').classList.add('hidden');
            document.getElementById('bookingStep3').classList.add('hidden');
            document.getElementById('bookingStep4').classList.remove('hidden');
        }
        
        function updateProgressBar() {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                if (i <= currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            }
        }
        
        function confirmBooking() {
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    
    const appointment = {
        patient: currentUser.username,
        type: selectedType,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        doctor: "Dr. Sarah Johnson",
        status: "pending"
    };

    // Save appointment
    appointments.push(appointment);
    saveAppointments();

    // Reset booking flow UI
    document.getElementById('bookingFlow').classList.add('hidden');
    showNotification('Appointment booked successfully!', 'success');

    // Reload patient appointments list
    loadPatientAppointments();
    backToPatientHome(); 
}
        
        function cancelAppointment(button) {
            const appointmentItem = button.closest('.appointment-item');
            appointmentItem.remove();
            showNotification('Appointment cancelled', 'info');
        }
                    
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
function login() {
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();

    const user = users.find(u => u.username === username && u.password === password);

    if (!user) {
        showNotification("Invalid username or password", "error");
        return;
    }

    // Store user session
    localStorage.setItem("currentUser", JSON.stringify(user));

    // Redirect based on role
    if (user.role === "patient") {
        showPatientPortal();
    } else if (user.role === "admin") {
        showAdminDashboard();
    }
}
    </script>
</body>
</html>
